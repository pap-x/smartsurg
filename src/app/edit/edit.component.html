<div class="flex row title-bar">
  <div class="logo-div">
    <img src="../../assets/images/logo.jpg" height="60px" width="60px">
    <p class="title-text">SMARTSurg</p>
  </div>
  <div class="procedure-name-div">
    <h2>{{procedure.name}} | {{procedure.type}}</h2>
  </div>  
</div>
<hr>
<div class="flex row main">
  <div class="phases-bar">
    <p class="phases-bar-title">{{procedure.name}} PHASES</p>
    <a [routerLink]="" *ngFor="let phase of procedure.phases; let i = index" [class.active]="selected_phase === i" (click)="onSelectedPhase(i)" class="phase-button">
      <span *ngIf="selected_phase != i || editPhase!=i+1">{{phase.name | limitchar:22}}</span>
      <span *ngIf="selected_phase === i&&editPhase==i+1"><input name="phase-name" id={{phase.id}} type="text" class="name-edit form-control" value="{{phase.name}}" autofocus></span>  
      <span *ngIf="selected_phase === i&&editPhase==i+1" class="check-icon fas fa-check" (click)="onSaveNamePhase(phase.id)"></span> 
      <span *ngIf="selected_phase === i&&editPhase!=i+1" class="delete2-icon fas fa-trash-alt" (click)="onDelete('phase', phase.name, phase.id)"></span>
      <span *ngIf="selected_phase === i&&editPhase!=i+1" class="edit2-icon fas fa-edit" (click)="editPhase=i+1"></span>
    </a>
    <div class="add-div">
      <button class="add-btn btn btn-primary" (click)="onAdd('phase')"><span class="add-icon fas fa-plus"></span>Add Phase</button>
    </div>
  </div>
  <div class="steps-bar">
    <p class="steps-bar-title">{{procedure.phases[selected_phase].name | addspaces | uppercase}}</p>
    <a [routerLink]="" *ngFor="let step of procedure.phases[selected_phase].steps; let i = index" [class.active]="selected_step === i" (click)="onSelectedStep(i)" class="step-button">
      <span *ngIf="editStep!=i+1">{{step.name | limitchar:38}}</span>
      <span *ngIf="editStep==i+1"><input name="step-name" id={{step.id}} type="text" class="name-edit-step form-control" value="{{step.name}}" autofocus></span>  
      <span *ngIf="editStep==i+1" class="check-icon fas fa-check" (click)="onSaveNameStep(step.id)"></span> 
      <span *ngIf="selected_step === i&&editStep!=i+1" class="delete2-icon fas fa-trash-alt" (click)="onDelete('step', step.name, step.id)"></span>
      <span *ngIf="selected_step === i&&editStep!=i+1" class="edit2-icon fas fa-edit" (click)="editStep=i+1"></span>
    </a>
    <div class="add-div">
      <button class="add-btn btn btn-primary" (click)="onAdd('step')"><span class="add-icon fas fa-plus"></span>Add Step</button>
    </div>
  </div>

  <div class="main-window" *ngIf="addMode=='no'&&editMode=='no'">
    <h4>Step: {{procedure.phases[selected_phase].steps[selected_step].name | addspaces}}</h4>
    <div class="substep-box" *ngFor="let substep of procedure.phases[selected_phase].steps[selected_step].substeps; let i = index" [class.parallel]="isParallel(substep, i)">
      <div class="substep-div">
        <span class="delete-icon fas fa-trash-alt" (click)="onDelete('substep', substep.name, substep.id)"></span>
        <span class="edit-icon fas fa-edit" (click)="onEdit('substep', substep.name, i)"></span>
        <p><b>Substep Name:</b> {{substep.name | addspaces}}</p>
        <p><b>Action:</b> {{substep.action | addspaces}}</p>
        <table *ngIf="substep.instruments[0]" class="table table-sm table-bordered instrument-table">
          <thead>
            <tr>
              <th>Instrument</th>
              <th>Assigned</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let instrument of substep.instruments">
              <td>{{instrument.id | addspaces}}</td>
              <td>{{instrument.assigned}}</td>
            </tr>
          </tbody>
        </table>
        <p><b>Anatomies:</b> {{substep.anatomies | addspacesarray}}</p>
        <p><b>Extras:</b> {{substep.extras | addspacesarray}}</p>
      </div>
      <div class="substep-img"><img src="../../assets/images{{substep.image}}" width="280px"></div>
    </div>
    <div class="add-div">
      <button class="add-btn btn btn-primary" (click)="onAdd('substep')"><span class="add-icon fas fa-plus"></span>Add Substep</button>
    </div>
  </div>

  <div class="add-substep-window" *ngIf="addMode=='substep'">
    <div id="substep-form-div">
      <div class="title-text">Add a new Substep inside Step: <b>{{ procedure.phases[selected_phase].steps[selected_step].name | addspaces }}</b></div>
      <form id="substep-form" #substepForm="ngForm">
          <select class="custom-select edit-form-input substep-placement" autofocus [(ngModel)]="placement" name="substep-placement">
            <option value="none" disabled selected>Substep Placement</option>
            <option value="parallel">Parallel</option>
            <option value="before">Before</option>
            <option value="after">After</option>
          </select>
          <select class="custom-select edit-form-input substep-order" id="sel-order" [(ngModel)]="add_substep.order" #substepPosition
          autofocus 
          name="procedure-position">
            <option value="0" disabled selected>Select Substep</option>
            <option *ngFor="let substep of procedure.phases[selected_phase].steps[selected_step].substeps; let i=index" value={{substep.order}}>{{substep.name | addspaces}}</option>
          </select>
          <input name="substep-name" id="substep-name" type="text" class="form-control edit-form-input" placeholder="Substep Name" autofocus required [(ngModel)]="add_substep.name" #substepName>
          <select class="custom-select edit-form-input" id="sel-action" [(ngModel)]="add_substep.action" #substepAction
            autofocus 
            name="substep-action" (change)="onActionChange(add_substep.action)">
              <option value="none" disabled>Select Action</option>
              <option *ngFor="let action of actions; let i=index" value={{action}}>{{action | addspaces}}</option>
          </select>
          <select class="custom-select edit-form-input" id="sel-instruments" [(ngModel)]="instrument" #substepInstrument
            autofocus 
            name="procedure-instrument">
              <option value="none" disabled>Select Instrument</option>
              <option *ngFor="let instrument of instruments; let i=index" value={{instrument}}>{{instrument | addspaces}}</option>
          </select><button class="add-btn btn btn-primary btn-sm add-btn-sm" (click)="onAddInstrument('substep')"><span class="add-icon fas fa-plus"></span>Add Instrument</button>
          <table *ngIf="add_substep.instruments[0].id!=''" class="table table-sm table-bordered instrument-table">
            <thead>
              <tr>
                <th>Instrument</th>
                <th>Assigned</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let instrument of add_substep.instruments">
                <td>{{instrument.id | addspaces}}</td>
                <td><select name="instrument-assigned" class="custom-select" [(ngModel)]="instrument.assigned">
                      <option value="none">None</option>
                      <option value="Robot Left" [disabled]="disableAssignOptionAdd('Robot Left', 'substep')">Robot Left</option>
                      <option value="Robot Right" [disabled]="disableAssignOptionAdd('Robot Right', 'substep')">Robot Right</option>
                      <option value="Assistant Left" [disabled]="disableAssignOptionAdd('Assistant Left', 'substep')">Assistant Left</option>
                      <option value="Assistant Right" [disabled]="disableAssignOptionAdd('Assistant Right', 'substep')">Assistant Right</option>
                    </select></td>
              </tr>
            </tbody>
          </table>
          <select class="custom-select edit-form-input" id="sel-anatomy" [(ngModel)]="anatomy" #substepAnatomy
            autofocus 
            name="procedure-anatomy">
              <option value="none" disabled>Select Anatomy</option>
              <option *ngFor="let anatomy of anatomies; let i=index" value={{anatomy}}>{{anatomy | addspaces}}</option>
          </select><button class="add-btn btn btn-primary btn-sm add-btn-sm add-btn-anatomy" (click)="onAddAnatomy('substep')"><span class="add-icon fas fa-plus"></span>Add Anatomy</button>
          <p class="inline-form-p">Selected Anatomies: <span *ngFor="let anatomy of add_substep.anatomies">| {{ anatomy | addspaces}} </span></p>
          <input name="substep-extras" id="substep-extras" type="text" class="form-control edit-form-input" placeholder="Extras" autofocus [(ngModel)]="add_substep.extras" #substepExtras>          
          <div class="image-div">
            <label for="file-upload" class="custom-file-upload">
              <i class="fa fa-images"></i> Select Image
            </label>
            <input id="file-upload" type="file" (change)="imageFileEvent($event)"/>
            <p class="image-file">{{selectedImage}}</p>
          </div>
          <div class="save-btn"><button type="submit" class="btn btn-primary" id="substep-save-btn" [disabled]="!substepForm.form.valid" (click)="onSaveSubstep()">Save</button></div>
      </form>
    </div>
  </div>

  <div class="add-step-window" *ngIf="addMode=='step'">
    <div id="step-form-div">
      <div class="title-text">Add a new Step inside Phase: <b>{{ procedure.phases[selected_phase].name | addspaces }}</b></div>
      <form id="step-form" #stepForm="ngForm">
        <select class="custom-select edit-form-input substep-placement" autofocus [(ngModel)]="placement" name="step-placement">
          <option value="none" disabled selected>Step Placement</option>
          <option value="before">Before</option>
          <option value="after">After</option>
        </select>
        <select class="custom-select edit-form-input substep-order" id="sel-order" [(ngModel)]="add_step.order" #stepPosition
        autofocus 
        name="procedure-position">
          <option value="0" disabled selected>Select Step</option>
          <option *ngFor="let step of procedure.phases[selected_phase].steps; let i=index" value={{step.order}}>{{step.name | addspaces}}</option>
        </select>
        <input name="step-name" id="step-name" type="text" class="form-control edit-form-input" placeholder="Step Name" autofocus required [(ngModel)]="add_step.name" #stepName>
        <div *ngIf="add_step.name">
          <hr>
          <div class="title-text">Details of the first Substep of Step: <b>{{ add_step.name}}</b></div>
          <input name="substep-name" id="substep-name" type="text" class="form-control edit-form-input" placeholder="Substep Name" autofocus required [(ngModel)]="add_step.substep.name" #substepName>
          <select class="custom-select edit-form-input" id="sel-action" [(ngModel)]="add_step.substep.action" #substepAction
            autofocus 
            name="substep-action" (change)="onActionChange(add_step.substep.action)">
              <option value="none" disabled>Select Action</option>
              <option *ngFor="let action of actions; let i=index" value={{action}}>{{action | addspaces}}</option>
          </select>          
          <select class="custom-select edit-form-input" id="sel-instruments" [(ngModel)]="this.instrument" #substepInstrument
            autofocus 
            name="procedure-instrument">
              <option value="none" disabled>Select Instrument</option>
              <option *ngFor="let instrument of instruments; let i=index" value={{instrument}}>{{instrument | addspaces}}</option>
          </select><button class="add-btn btn btn-primary btn-sm add-btn-sm" (click)="onAddInstrument('step')"><span class="add-icon fas fa-plus"></span>Add Instrument</button>
          <table *ngIf="add_step.substep.instruments[0].id!=''" class="table table-sm table-bordered instrument-table">
            <thead>
              <tr>
                <th>Instrument</th>
                <th>Assigned</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let instrument of add_step.substep.instruments">
                <td>{{instrument.id | addspaces}}</td>
                <td><select name="instrument-assigned" class="custom-select" [(ngModel)]="instrument.assigned">
                      <option value="none">None</option>
                      <option value="Robot Left" [disabled]="disableAssignOptionAdd('Robot Left', 'step')">Robot Left</option>
                      <option value="Robot Right" [disabled]="disableAssignOptionAdd('Robot Right', 'step')">Robot Right</option>
                      <option value="Assistant Left" [disabled]="disableAssignOptionAdd('Assistant Left', 'step')">Assistant Left</option>
                      <option value="Assistant Right" [disabled]="disableAssignOptionAdd('Assistant Right', 'step')">Assistant Right</option>
                    </select></td>
              </tr>
            </tbody>
          </table>
          <select class="custom-select edit-form-input" id="sel-anatomy" [(ngModel)]="anatomy" #substepAnatomy
            autofocus 
            name="procedure-anatomy">
              <option value="none" disabled>Select Anatomy</option>
              <option *ngFor="let anatomy of anatomies; let i=index" value={{anatomy}}>{{anatomy | addspaces}}</option>
          </select><button class="add-btn btn btn-primary btn-sm add-btn-sm add-btn-anatomy" (click)="onAddAnatomy('step')"><span class="add-icon fas fa-plus"></span>Add Anatomy</button>
          <p class="inline-form-p">Selected Anatomies: <span *ngFor="let anatomy of add_step.substep.anatomies">| {{ anatomy | addspaces}} </span></p>
          <input name="substep-extras" id="substep-extras" type="text" class="form-control edit-form-input" placeholder="Extras" autofocus [(ngModel)]="add_step.substep.extras" #substepExtras>          
          <div class="image-div">
            <label for="file-upload" class="custom-file-upload">
              <i class="fa fa-images"></i> Select Image
            </label>
            <input id="file-upload" type="file" (change)="imageFileEvent($event)"/>
            <p class="image-file">{{selectedImage}}</p>
          </div>
          <div class="save-btn"><button type="submit" class="btn btn-primary" id="substep-save-btn" [disabled]="!stepForm.form.valid" (click)="onSaveStep()">Save</button></div>
        </div>
      </form>
    </div>
  </div>

  <div class="add-phase-window" *ngIf="addMode=='phase'">
    <div id="phase-form-div">
      <div class="title-text">Add a new Phase</div>
      <form id="phase-form" #phaseForm="ngForm">
        <select class="custom-select edit-form-input substep-placement" autofocus [(ngModel)]="placement" name="phase-placement">
          <option value="none" disabled selected>Phase Placement</option>
          <option value="before">Before</option>
          <option value="after">After</option>
        </select>
        <select class="custom-select edit-form-input substep-order" id="sel-order" [(ngModel)]="add_phase.order" #phasePosition
        autofocus 
        name="procedure-position">
          <option value="0" disabled selected>Select Phase</option>
          <option *ngFor="let phase of procedure.phases; let i=index" value={{phase.order}}>{{phase.name | addspaces}}</option>
        </select>
        <input name="phase-name" id="phase-name" type="text" class="form-control edit-form-input" placeholder="Phase Name" autofocus required [(ngModel)]="add_phase.name" #phaseName>
        <div *ngIf="add_phase.name">
          <hr>
          <div class="title-text">Details of the first Step of Phase: <b>{{ add_phase.name}}</b></div>
          <input name="step-name" id="step-name" type="text" class="form-control edit-form-input" placeholder="Step Name" autofocus required [(ngModel)]="add_phase.step.name" #stepName>
        </div>
        <div *ngIf="add_phase.step.name">
          <hr>
          <div class="title-text">Details of the first Substep of Step: <b>{{ add_phase.step.name}}</b></div>
          <input name="substep-name" id="substep-name" type="text" class="form-control edit-form-input" placeholder="Substep Name" autofocus required [(ngModel)]="add_phase.step.substep.name" #substepName>
          <select class="custom-select edit-form-input" id="sel-action" [(ngModel)]="add_phase.step.substep.action" #substepAction
            autofocus 
            name="substep-action" (change)="onActionChange(add_phase.step.substep.action)">
              <option value="none" disabled>Select Action</option>
              <option *ngFor="let action of actions; let i=index" value={{action}}>{{action | addspaces}}</option>
          </select>  
          <select class="custom-select edit-form-input" id="sel-instruments" [(ngModel)]="this.instrument" #substepInstrument
            autofocus 
            name="procedure-instrument">
              <option value="none" disabled>Select Instrument</option>
              <option *ngFor="let instrument of instruments; let i=index" value={{instrument}}>{{instrument | addspaces}}</option>
          </select><button class="add-btn btn btn-primary btn-sm add-btn-sm" (click)="onAddInstrument('phase')"><span class="add-icon fas fa-plus"></span>Add Instrument</button>
          <table *ngIf="add_phase.step.substep.instruments[0].id!=''" class="table table-sm table-bordered instrument-table">
            <thead>
              <tr>
                <th>Instrument</th>
                <th>Assigned</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let instrument of add_phase.step.substep.instruments">
                <td>{{instrument.id | addspaces}}</td>
                <td><select name="instrument-assigned" class="custom-select" [(ngModel)]="instrument.assigned">
                      <option value="none">None</option>
                      <option value="Robot Left" [disabled]="disableAssignOptionAdd('Robot Left', 'phase')">Robot Left</option>
                      <option value="Robot Right" [disabled]="disableAssignOptionAdd('Robot Right', 'phase')">Robot Right</option>
                      <option value="Assistant Left" [disabled]="disableAssignOptionAdd('Assistant Left', 'phase')">Assistant Left</option>
                      <option value="Assistant Right" [disabled]="disableAssignOptionAdd('Assistant Right', 'phase')">Assistant Right</option>
                    </select></td>
              </tr>
            </tbody>
          </table>
          <select class="custom-select edit-form-input" id="sel-anatomy" [(ngModel)]="anatomy" #substepAnatomy
            autofocus 
            name="procedure-anatomy">
              <option value="none" disabled>Select Anatomy</option>
              <option *ngFor="let anatomy of anatomies; let i=index" value={{anatomy}}>{{anatomy | addspaces}}</option>
          </select><button class="add-btn btn btn-primary btn-sm add-btn-sm add-btn-anatomy" (click)="onAddAnatomy('phase')"><span class="add-icon fas fa-plus"></span>Add Anatomy</button>
          <p class="inline-form-p">Selected Anatomies: <span *ngFor="let anatomy of add_phase.step.substep.anatomies">| {{ anatomy | addspaces}} </span></p>
          <input name="substep-extras" id="substep-extras" type="text" class="form-control edit-form-input" placeholder="Extras" autofocus [(ngModel)]="add_phase.step.substep.extras" #substepExtras>          
          <div class="image-div">
            <label for="file-upload" class="custom-file-upload">
              <i class="fa fa-images"></i> Select Image
            </label>
            <input id="file-upload" type="file" (change)="imageFileEvent($event)"/>
            <p class="image-file">{{selectedImage}}</p>
          </div>
          <div class="save-btn"><button type="submit" class="btn btn-primary" id="substep-save-btn" [disabled]="!phaseForm.form.valid" (click)="onSavePhase()">Save</button></div>
        </div>
      </form>
    </div>
  </div>

  <div class="edit-substep-window" *ngIf="editMode=='substep'&&addMode=='no'">
    <div id="substep-form-div">
      <div class="title-text">Editing Substep: <b>{{ edit_substep.name | addspaces }}</b></div>
      <form id="substep-form" #substepEditForm="ngForm">
          <input name="substep-name" id="substep-name" type="text" class="form-control edit-form-input" placeholder="Substep Name" 
              autofocus required 
              [(ngModel)]="edit_substep.name" #substepName
              value="{{edit_substep.name}}">
          <select class="custom-select edit-form-input" id="sel-action" [(ngModel)]="edit_substep.action" #substepAction
            autofocus 
            name="substep-action" (change)="onActionChange(edit_substep.action)">
              <option value="none" disabled>Select Action</option>
              <option *ngFor="let action of actions; let i=index" value={{action}}>{{action | addspaces}}</option>
          </select>
          <table *ngIf="edit_substep.instruments[0]" class="table table-sm table-bordered instrument-table">
            <thead>
              <tr>
                <th>Instrument</th>
                <th>Assigned</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let instrument of edit_substep.instruments">
                <td>{{instrument.id | addspaces}}</td>
                <td><select name="instrument-assigned" class="custom-select" [(ngModel)]="instrument.assigned">
                      <option value="none">None</option>
                      <option value="Robot Left" [disabled]="disableAssignOption('Robot Left')">Robot Left</option>
                      <option value="Robot Right" [disabled]="disableAssignOption('Robot Right')">Robot Right</option>
                      <option value="Assistant Left" [disabled]="disableAssignOption('Assistant Left')">Assistant Left</option>
                      <option value="Assistant Right" [disabled]="disableAssignOption('Assistant Right')">Assistant Right</option>
                    </select></td>
              </tr>
            </tbody>
          </table>
          <select class="custom-select edit-form-input" id="sel-instruments" [(ngModel)]="this.instrument" #substepInstrument
            autofocus 
            name="procedure-instrument">
              <option value="none" disabled>Select Instrument</option>
              <option *ngFor="let instrument of instruments; let i=index" value={{instrument}}>{{instrument | addspaces}}</option>
          </select><button class="add-btn btn btn-primary btn-sm add-btn-sm" (click)="onAddInstrumentEdit('substep')"><span class="add-icon fas fa-plus"></span>Add Instrument</button>
          <select class="custom-select edit-form-input" id="sel-anatomy" [(ngModel)]="anatomy" #substepAnatomy
            autofocus 
            name="procedure-anatomy">
              <option value="none" disabled>Select Anatomy</option>
              <option *ngFor="let anatomy of anatomies; let i=index" value={{anatomy}}>{{anatomy | addspaces}}</option>
          </select><button class="add-btn btn btn-primary btn-sm add-btn-sm  add-btn-anatomy" (click)="onAddAnatomyEdit('substep')"><span class="add-icon fas fa-plus"></span>Add Anatomy</button>
          <p class="inline-form-p">Selected Anatomies: <span *ngFor="let anatomy of edit_substep.anatomies">| {{ anatomy | addspaces}} </span></p>
          <input name="substep-extras" id="substep-extras" type="text" class="form-control edit-form-input" placeholder="Extras" autofocus [(ngModel)]="add_substep.extras" #substepExtras>          
          <div class="image-div">
            <label for="file-upload" class="custom-file-upload">
              <i class="fa fa-images"></i> Select Image
            </label>
            <input id="file-upload" type="file" (change)="imageFileEvent($event)"/>
            <p class="image-file">{{selectedImage}}</p>
          </div>
          <div class="save-btn"><button type="submit" class="btn btn-primary" id="substep-save-btn" [disabled]="!substepEditForm.form.valid" (click)="onSaveEditSubstep()">Save</button></div>
      </form>
    </div>
  </div>

</div>